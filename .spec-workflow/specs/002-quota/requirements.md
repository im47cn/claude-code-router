# 配额系统需求文档

## 1. 概述

本文档定义了 `claude-code-router` 配额系统的功能需求。该系统旨在通过限制用户和/或其 API 密钥在特定时间窗口内的请求次数来控制资源使用。

## 2. 功能需求

### 2.1 配额规则定义

* **FR-QUOTA-DEF-001**: 配额规则 **必须** 基于**请求次数** (`limit`) 和**时间窗口** (`interval_minutes`) 进行定义。
* **FR-QUOTA-DEF-002**: `limit` **必须** 是一个正整数，表示在指定时间窗口内允许的最大**成功**请求次数。
* **FR-QUOTA-DEF-003**: `interval_minutes` **必须** 是一个正整数，表示时间窗口的长度（以分钟为单位）。

### 2.2 配额层级与独立性

* **FR-QUOTA-LEVEL-001**: 系统 **必须** 支持两个独立的配额层级：用户级配额和 API 密钥级配额。
* **FR-QUOTA-LEVEL-002**: 用户级配额由**管理员**设置，并应用于该用户通过其**任何** API 密钥发起的**所有**请求。
* **FR-QUOTA-LEVEL-003**: API 密钥级配额由**用户**为其**单个** API 密钥设置，并仅应用于通过该特定 API 密钥发起的请求。
* **FR-QUOTA-LEVEL-004**: 用户级配额和 API 密钥级配额 **必须** 独立检查。**任一层级**的配额超限都会导致请求被拒绝。

### 2.3 配额检查与执行

* **FR-QUOTA-CHECK-001**: 对于每一个通过 API 密钥认证的请求，系统 **必须** 在处理请求（路由到 LLM）之前检查配额。
* **FR-QUOTA-CHECK-002**: 配额检查 **必须** 首先检查用户级配额（如果已设置）。
* **FR-QUOTA-CHECK-003**: 如果用户级配额检查通过（或未设置），系统 **必须** 接着检查该 API 密钥的配额（如果已设置）。
* **FR-QUOTA-CHECK-004**: 配额检查 **必须** 基于在过去 `interval_minutes` 分钟内，对应用户 ID 或 API 密钥 ID 的**成功** (`status = 'success'`) 请求数量。
* **FR-QUOTA-CHECK-005**: 如果任一配额检查显示请求数量已达到或超过 `limit`，请求 **必须** 被拒绝。
* **FR-QUOTA-CHECK-006**: 被拒绝的请求 **必须** 返回 `HTTP 429 Too Many Requests` 状态码。
* **FR-QUOTA-CHECK-007**: 配额超限的请求 **必须** 被记录到请求日志中，状态为 `'quota_exceeded'`。

### 2.4 配额管理 (UI/API)

* **FR-QUOTA-MGT-001 (管理员)**: 管理员 **必须** 能够为任何用户设置、更新或移除用户级配额规则 (`limit`, `interval_minutes`)。
* **FR-QUOTA-MGT-002 (用户)**: 用户 **必须** 能够为自己的任何一个 API 密钥设置、更新或移除 API 密钥级配额规则 (`limit`, `interval_minutes`)。
* **FR-QUOTA-MGT-003**: 系统 **应** 在 UI 中清晰地展示用户当前的配额规则和 API 密钥的配额规则。
* **FR-QUOTA-MGT-004**: 配额规则的更改 **应** 尽快生效（考虑到缓存的 TTL）。

## 3. 非功能性需求

* **NFR-QUOTA-001**: 配额检查过程对 API 请求延迟的影响应尽可能小，目标 P99 < 20ms (不含数据库查询)。
* **NFR-QUOTA-002**: 配额计数应具有合理的一致性，允许由于异步日志记录带来的微小延迟误差。

## 4. 假设与约束

* **A-QUOTA-001**: 配额检查依赖于 `request_logs` 表中记录的成功请求。
* **C-QUOTA-001**: 初始版本仅支持基于请求次数的频率限制。未来可能需要扩展支持基于 Token 的配额。
* **C-QUOTA-002**: 配额统计的时间窗口是滑动的（例如，“过去 60 分钟”）。
