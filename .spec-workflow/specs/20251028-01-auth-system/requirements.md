# 需求文档 - 认证与 API 密钥管理系统

## 基本信息

**规范名称**: 20251028-01-auth-system
**功能描述**: 认证与 API 密钥管理系统
**创建日期**: 2025-10-28
**版本**: 1.0
**负责人**: 开发团队

## 1. 背景与目标

### 1.1 项目背景
`claude-code-router` 是一个基于 TypeScript 的路由服务，用于将 Claude Code 的请求路由到不同的大语言模型提供商。当前系统缺乏完善的用户认证和 API 密钥管理机制，需要实现一个安全的、基于角色的访问控制系统。

### 1.2 业务目标
- 提供安全的用户认证机制，支持飞书 OAuth 登录
- 实现完整的 API 密钥生命周期管理
- 建立基于角色的权限控制系统
- 确保系统安全性和可扩展性

### 1.3 成功标准
- 用户能够通过飞书安全登录系统
- 用户能够自主管理 API 密钥（创建、查看、禁用、删除）
- API 请求通过密钥进行安全认证
- 系统支持管理员权限控制
- 满足性能要求（认证延迟 P99 < 50ms）

## 2. 用户故事与验收标准

### 2.1 用户认证 (UI)

#### US-AUTH-001: 飞书登录
**作为** 系统用户
**我希望** 能够通过飞书账号登录系统
**以便** 快速安全地访问路由服务功能

**验收标准:**
- **WHEN** 用户点击"使用飞书登录"按钮 **THEN** 系统 **必须** 重定向到飞书 OAuth 授权页面
- **WHEN** 用户在飞书页面完成授权 **THEN** 系统 **必须** 自动创建用户账户（首次登录）并登录
- **WHEN** 用户登录成功 **THEN** 系统 **必须** 维持登录状态并通过 Session 或 JWT 管理
- **WHEN** 用户查看页面 **THEN** 系统 **应该** 显示用户的基本信息（姓名、头像）
- **IF** 用户是管理员 **THEN** 系统 **应该** 在 UI 中展示管理员特定功能入口

#### US-AUTH-002: 用户登出
**作为** 已登录用户
**我希望** 能够安全地退出系统
**以便** 保护我的账户安全

**验收标准:**
- **WHEN** 用户点击登出按钮 **THEN** 系统 **必须** 清除用户的登录状态
- **WHEN** 用户登出后 **THEN** 系统 **必须** 重定向到登录页面或首页

### 2.2 API 认证 (后端服务)

#### US-API-AUTH-001: API 密钥认证
**作为** API 调用者
**我希望** 能够使用 API 密钥访问核心路由
**以便** 安全地调用 LLM 服务

**验收标准:**
- **WHEN** 客户端向 `/v1/messages` 发送请求 **THEN** 系统 **必须** 要求通过 API 密钥认证
- **WHEN** 客户端使用 `Authorization: Bearer <API_KEY>` 请求头 **THEN** 系统 **必须** 正确解析并验证密钥
- **WHEN** 客户端使用 `X-Api-Key: <API_KEY>` 请求头 **THEN** 系统 **必须** 正确解析并验证密钥
- **WHEN** API 密钥有效且启用 **THEN** 系统 **必须** 允许请求继续处理
- **WHEN** API 密钥无效、缺失或已禁用 **THEN** 系统 **必须** 返回 401 Unauthorized 错误
- **WHEN** 密钥关联用户被禁用 **THEN** 系统 **必须** 返回 403 Forbidden 错误

#### US-API-AUTH-002: 密钥安全性
**作为** 系统管理员
**我希望** API 密钥得到安全存储和验证
**以便** 保护用户和系统的安全

**验收标准:**
- **WHEN** 存储 API 密钥 **THEN** 系统 **必须** 使用强哈希算法（bcrypt 或 Argon2）加盐存储
- **WHEN** 验证 API 密钥 **THEN** 系统 **必须** 使用恒定时间比较算法防止时序攻击
- **WHEN** 记录日志或返回响应 **THEN** 系统 **不得** 明文存储或返回完整的 API 密钥

### 2.3 API 密钥管理 (UI)

#### US-KEY-MGT-001: 创建 API 密钥
**作为** 已登录用户
**我希望** 能够创建新的 API 密钥
**以便** 用于访问路由服务 API

**验收标准:**
- **WHEN** 用户点击"创建密钥"按钮 **THEN** 系统 **必须** 生成新的高熵 API 密钥
- **WHEN** 用户为密钥指定名称 **THEN** 系统 **应该** 保存该名称便于识别
- **WHEN** 密钥创建成功 **THEN** 系统 **必须** 完整显示密钥**仅一次**并提示用户妥善保存
- **WHEN** 用户关闭创建对话框后 **THEN** 系统 **不得** 再次完整显示该密钥

#### US-KEY-MGT-002: 查看 API 密钥列表
**作为** 已登录用户
**我希望** 能够查看我创建的所有 API 密钥
**以便** 管理我的访问凭证

**验收标准:**
- **WHEN** 用户访问密钥管理页面 **THEN** 系统 **必须** 显示用户创建的所有 API 密钥列表
- **WHEN** 显示密钥列表 **THEN** 系统 **必须** 包含密钥名称、前缀、创建时间、最后使用时间、状态和配额规则
- **WHEN** 显示密钥列表 **THEN** 系统 **不得** 显示完整的密钥内容

#### US-KEY-MGT-003: 管理 API 密钥状态
**作为** 已登录用户
**我希望** 能够启用或禁用我的 API 密钥
**以便** 灵活控制密钥的可用性

**验收标准:**
- **WHEN** 用户启用密钥 **THEN** 系统 **必须** 立即允许该密钥用于 API 认证
- **WHEN** 用户禁用密钥 **THEN** 系统 **必须** 立即拒绝该密钥的认证请求
- **WHEN** 用户删除密钥 **THEN** 系统 **必须** 显示确认提示并在确认后永久删除

#### US-KEY-MGT-004: 设置密钥配额
**作为** 已登录用户
**我希望** 能够为每个 API 密钥设置独立的配额规则
**以便** 控制使用量和成本

**验收标准:**
- **WHEN** 用户设置密钥配额（请求次数限制和时间窗口）**THEN** 系统 **必须** 保存并应用这些规则
- **WHEN** API 请求超过配额限制 **THEN** 系统 **必须** 返回 429 Too Many Requests 错误
- **WHEN** 配额时间窗口过期 **THEN** 系统 **必须** 重置计数器并允许新的请求

### 2.4 用户角色与权限

#### US-ROLE-001: 基于角色的访问控制
**作为** 系统管理员
**我希望** 系统能够区分普通用户和管理员
**以便** 实施不同的权限控制

**验收标准:**
- **WHEN** 用户通过飞书首次登录 **THEN** 系统 **必须** 设置为普通用户角色
- **WHEN** 管理员用户访问系统 **THEN** 系统 **应该** 显示管理员特定的功能界面
- **WHEN** 普通用户尝试访问管理员功能 **THEN** 系统 **必须** 拒绝访问
- **WHEN** 普通用户管理自己的密钥 **THEN** 系统 **必须** 允许这些操作
- **WHEN** 普通用户查看数据 **THEN** 系统 **必须** 只显示其自己的相关信息

## 3. 非功能性需求

### 3.1 性能需求
- **NFR-PERF-001**: API 密钥验证过程的目标 P99 延迟应小于 50ms（不含数据库查询）
- **NFR-PERF-002**: 用户登录处理（飞书回调）的目标 P99 延迟应小于 500ms（不含飞书响应时间）

### 3.2 安全需求
- **NFR-SEC-001**: 飞书 OAuth 使用的 App ID 和 App Secret 必须安全存储，不得硬编码
- **NFR-SEC-002**: Session 或 JWT 管理必须使用安全措施（HttpOnly Cookie，安全签名密钥）
- **NFR-SEC-003**: 所有用户输入都必须进行验证和清理，防止注入攻击
- **NFR-SEC-004**: 系统必须实施适当的 CSRF 防护措施

### 3.3 可用性需求
- **NFR-AVAIL-001**: 认证服务应达到 99.9% 的可用性
- **NFR-AVAIL-002**: 数据库连接失败时应具备优雅降级机制

### 3.4 可维护性需求
- **NFR-MAIN-001**: 认证逻辑应模块化，便于测试和维护
- **NFR-MAIN-002**: 日志记录应完整但不得包含敏感信息

## 4. 技术约束与假设

### 4.1 技术约束
- **CONST-TECH-001**: 后端框架必须使用 Fastify
- **CONST-TECH-002**: 数据库必须使用 MySQL
- **CONST-TECH-003**: 密码哈希必须使用 bcrypt 或 Argon2
- **CONST-TECH-004**: 初始版本仅支持飞书作为登录方式

### 4.2 业务约束
- **CONST-BIZ-001**: 不得提供本地注册功能
- **CONST-BIZ-002**: 用户首次登录必须通过飞书自动创建账户
- **CONST-BIZ-003**: 管理员权限设置需要在数据库层面手动配置

### 4.3 假设条件
- **ASSUME-001**: 飞书开放平台提供可靠的 OAuth2 服务
- **ASSUME-002**: 系统部署环境能够安全地管理飞书 App Secret 和 JWT/Session 密钥
- **ASSUME-003**: 用户具备飞书账号并能够完成 OAuth 授权

## 5. 依赖关系

### 5.1 外部依赖
- **飞书开放平台 OAuth2 API**
- **MySQL 数据库服务**
- **Redis 缓存服务（可选）**

### 5.2 内部依赖
- **现有的路由服务核心功能**
- **配额管理服务**
- **日志记录服务**

## 6. 验收测试策略

### 6.1 单元测试
- API 密钥生成、哈希、验证逻辑测试
- 配额检查逻辑测试
- 用户认证状态管理测试

### 6.2 集成测试
- 完整的飞书 OAuth 登录流程测试
- API 密钥认证钩子测试
- 配额限制执行测试

### 6.3 端到端测试
- 用户登录、密钥管理全流程测试
- API 调用认证流程测试
- 权限控制验证测试

### 6.4 安全测试
- API 密钥泄露风险评估
- 时序攻击防护测试
- CSRF 防护机制测试

## 7. 风险评估

### 7.1 技术风险
- **飞书 API 变更风险**: 中等 - 需要关注飞书开放平台的更新
- **性能瓶颈风险**: 低 - 通过缓存和优化查询可以缓解

### 7.2 安全风险
- **密钥泄露风险**: 高 - 需要严格的安全措施和审计
- **权限绕过风险**: 中等 - 需要充分的权限控制测试

### 7.3 业务风险
- **用户接受度风险**: 低 - 飞书是目标用户常用的办公工具

## 8. 成功指标

### 8.1 技术指标
- API 认证成功率 > 99.9%
- 认证延迟 P99 < 50ms
- 系统可用性 > 99.9%

### 8.2 业务指标
- 用户登录成功率 > 95%
- API 密钥创建成功率 > 99%
- 用户投诉 < 1%