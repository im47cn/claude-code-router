# 任务文档

- [ ] 1. 实现 QuotaService
  - 文件: src/services/quotaService.ts
  - 实现 `checkUserQuota` 和 `checkApiKeyQuota` 方法，包括从缓存/数据库获取规则和查询 `request_logs`。
  - 目的: 封装配额检查的核心业务逻辑。
  - _重用: 数据库连接, 缓存工具_
  - _需求: 需求 3.1, 3.2_
  - _提示: 角色: 后端开发者 | 任务: 实现 QuotaService 及其方法 | 限制: 必须正确处理缓存未命中的情况 | 成功: 服务能准确返回配额是否超限。_

- [ ] 2. 实现配额规则缓存
  - 文件: src/services/quotaService.ts
  - 在 `QuotaService` 中实现 `userQuotaCache` 和 `apiKeyQuotaCache` 的读、写、失效逻辑。
  - 目的: 提升配额规则获取性能。
  - _重用: lru-cache_
  - _需求: 需求 2.4_
  - _提示: 角色: 后端开发者 | 任务: 实现缓存逻辑 | 限制: 需处理缓存失效 | 成功: 缓存按预期工作。_

- [ ] 3. 在认证中间件中集成配额检查
  - 文件: src/middleware/auth.ts (修改)
  - 在 API Key 验证成功后，注入并调用 `QuotaService`。
  - 目的: 在请求处理早期强制执行配额。
  - _重用: 认证中间件_
  - _需求: 需求 3.1_
  - _提示: 角色: 后端开发者 | 任务: 集成 QuotaService | 限制: 必须处理超限情况 | 成功: 超限请求被正确拒绝。_

- [ ] 4. 为 QuotaService 编写单元测试
  - 文件: tests/services/quotaService.test.ts
  - Mock 数据库和缓存，测试各种场景下的检查结果。
  - 目的: 确保配额检查逻辑的正确性。
  - _重用: 测试工具_
  - _需求: 需求 3.1, 3.2_
  - _提示: 角色: QA 工程师 | 任务: 编写单元测试 | 限制: 必须覆盖所有分支 | 成功: 测试覆盖率高，所有场景通过。_

- [ ] 5. 实现用户配额管理 API
  - 文件: src/api/admin.ts (修改)
  - 实现 `PUT/DELETE/GET /admin/users/{userId}/quota` 端点。
  - 目的: 提供管理员管理用户配额的接口。
  - _重用: API 路由结构_
  - _需求: 需求 4.1_
  - _提示: 角色: API 开发者 | 任务: 实现管理员 API | 限制: 需验证管理员权限 | 成功: API 按设计工作。_

- [ ] 6. 实现 API 密钥配额管理 API
  - 文件: src/api/keys.ts (修改)
  - 实现 `PUT/DELETE/GET /api/keys/{keyId}/quota` 端点。
  - 目的: 提供用户管理其 API 密钥配额的接口。
  - _重用: API 路由结构_
  - _需求: 需求 4.2_
  - _提示: 角色: API 开发者 | 任务: 实现用户 API | 限制: 需验证密钥归属 | 成功: API 按设计工作。_

- [ ] 7. 为配额管理 API 编写集成测试
  - 文件: tests/api/quota.test.ts
  - 测试所有配额管理 API 的 CRUD 操作和权限控制。
  - 目的: 确保 API 的正确性和安全性。
  - _重用: 集成测试框架_
  - _需求: 需求 4.1, 4.2_
  - _提示: 角色: QA 工程师 | 任务: 编写集成测试 | 限制: 需覆盖权限和边界情况 | 成功: 所有 API 测试通过。_

- [ ] 8. 在 UI 中集成 API 密钥配额显示与管理
  - 文件: ui/src/pages/ApiKeyManagementPage.tsx (修改)
  - 显示配额信息，并添加入/更新/移除配额的交互组件。
  - 目的: 提供用户友好的配额管理界面。
  - _重用: 现有 UI 组件_
  - _需求: 需求 4.3_
  - _提示: 角色: 前端开发者 | 任务: 实现 UI 集成 | 限制: 界面需清晰直观 | 成功: 用户可无障碍管理配额。_

- [ ] 9. 实现管理员的用户配额管理界面
  - 文件: ui/src/pages/Admin/UserQuotaPage.tsx
  - 创建新页面允许管理员搜索用户并管理其配额。
  - 目的: 为管理员提供强大的管理工具。
  - _重用: 现有 UI 组件_
  - _需求: 需求 4.1_
  - _提示: 角色: 前端开发者 | 任务: 创建管理员界面 | 限制: 需处理管理员权限 | 成功: 管理员可高效管理用户配额。_

- [ ] 10. 为配额 UI 功能编写 E2E 测试
  - 文件: tests/e2e/quota.test.ts
  - 覆盖用户和管理员管理配额的完整流程。
  - 目的: 确保端到端流程的正确性。
  - _重用: E2E 测试框架_
  - _需求: 需求 4.1, 4.2, 4.3_
  - _提示: 角色: QA 自动化工程师 | 任务: 编写 E2E 测试 | 限制: 需模拟真实用户操作 | 成功: 所有用户流程测试通过。_

- [ ] 11. 添加数据库索引
  - 文件: prisma/schema.prisma (修改)
  - 为 `request_logs` 表添加必要的复合索引。
  - 目的: 优化配额检查的查询性能。
  - _重用: Prisma 迁移_
  - _需求: 非功能性需求 1_
  - _提示: 角色: 数据库管理员 | 任务: 添加索引 | 限制: 需分析查询计划 | 成功: 查询延迟显著降低。_

## 原始文档的附加内容

### 依赖关系

- 配额检查逻辑依赖于 API Key 认证和日志记录。
- 配额管理 API 依赖于用户认证。
- UI 任务依赖于后端 API 实现。
