# 需求文档

## 简介

本文档定义了 `claude-code-router` 配额系统的功能需求。该系统旨在通过限制用户和/或其 API 密钥在特定时间窗口内的请求次数来控制资源使用。

## 产品愿景对齐

- **模型路由与成本优化**: 通过限制对昂贵模型的请求频率，帮助用户控制成本。
- **用户管理与访问控制**: 提供精细化的访问控制，允许管理员和用户根据需要设置请求上限。
- **可扩展性**: 架构支持未来扩展更复杂的配额类型，如基于 Token 的配额。

## 需求

### 需求1: 配额规则定义

**用户故事:** 作为管理员或用户，我希望定义清晰的配额规则，以便精确地控制请求频率。

#### 验收标准

1. WHEN 定义配额规则时 THEN 系统 SHALL 支持基于请求次数 (`limit`) 和时间窗口 (`interval_minutes`) 进行定义。
2. IF 设置 `limit` THEN 系统 SHALL 确保其为一个正整数，代表在时间窗口内允许的最大成功请求次数。
3. IF 设置 `interval_minutes` THEN 系统 SHALL 确保其为一个正整数，代表时间窗口的长度（以分钟为单位）。

### 需求2: 配额层级与独立性

**用户故事:** 作为系统管理员，我希望能够设置全局的用户级配额，同时允许用户自定义其 API 密钥的配额，以便实现多层次的访问控制。

#### 验收标准

1. WHEN 配置配额时 THEN 系统 SHALL 支持用户级和 API 密钥级两个独立的配额层级。
2. IF 管理员设置了用户级配额 THEN 该配额 SHALL 应用于该用户通过其任何 API 密钥发起的所有请求。
3. IF 用户为其单个 API 密钥设置了配额 THEN 该配额 SHALL 仅应用于通过该特定 API 密钥发起的请求。
4. WHEN 请求进入时 THEN 系统 SHALL 独立检查用户级和 API 密钥级配额，任一层级的配额超限都会导致请求被拒绝。

### 需求3: 配额检查与执行

**用户故事:** 作为系统，我需要在处理请求之前严格执行配额检查，以确保资源使用的公平性和可控性。

#### 验收标准

1. WHEN 接收到通过 API 密钥认证的请求时 THEN 系统 SHALL 在将请求路由到 LLM 之前执行配额检查。
2. WHEN 执行配额检查时 THEN 系统 SHALL 首先检查用户级配额（如果已设置）。
3. IF 用户级配额检查通过或未设置 THEN 系统 SHALL 接着检查该 API 密钥的配额（如果已设置）。
4. WHEN 计算配额时 THEN 系统 SHALL 基于在过去 `interval_minutes` 分钟内，对应用户 ID 或 API 密钥 ID 的成功 (`status = 'success'`) 请求数量。
5. IF 任一配额检查显示请求数量已达到或超过 `limit` THEN 系统 SHALL 拒绝该请求。
6. WHEN 请求因配额超限被拒绝时 THEN 系统 SHALL 返回 `HTTP 429 Too Many Requests` 状态码。
7. WHEN 请求因配额超限被拒绝时 THEN 系统 SHALL 在请求日志中将该请求的状态记录为 `quota_exceeded`。

### 需求4: 配额管理 (UI/API)

**用户故事:** 作为管理员或用户，我希望通过一个直观的界面或 API 来管理配额规则，以便轻松地调整访问策略。

#### 验收标准

1. 作为管理员 WHEN 管理用户时 THEN 我 SHALL 能够为任何用户设置、更新或移除用户级配额规则。
2. 作为用户 WHEN 管理我的 API 密钥时 THEN 我 SHALL 能够为自己的任何一个 API 密钥设置、更新或移除 API 密钥级配额规则。
3. WHEN 查看配额信息时 THEN UI SHALL 清晰地展示用户当前的配额规则和 API 密钥的配额规则。
4. WHEN 配额规则被更改时 THEN 更改 SHALL 尽快生效（考虑到缓存的TTL）。

### 需求5: 配额重置机制

**用户故事:** 作为系统，我需要定期重置配额计数器，以便确保配额周期性的准确执行。

#### 验收标准

1. WHEN 时间窗口到期时 THEN 系统 SHALL 自动重置对应的配额计数器
2. WHEN 配额规则被更新时 THEN 系统 SHALL 根据新规则重新计算当前配额使用情况
3. WHEN 用户或API密钥被删除时 THEN 系统 SHALL 清理其相关的配额计数缓存
4. IF 配额重置过程中发生错误 THEN 系统 SHALL 记录错误日志但不影响正常的配额检查

### 需求6: 配额一致性保证

**用户故事:** 作为系统，我需要确保在高并发场景下配额计算的准确性，以便避免竞态条件导致的配额超支。

#### 验收标准

1. WHEN 多个并发请求同时检查同一配额时 THEN 系统 SHALL 保证配额计算的原子性
2. WHEN 配额检查和日志记录并发进行时 THEN 系统 SHALL 确保配额计数的一致性
3. IF 发生配额计算冲突 THEN 系统 SHALL 采用保守策略，优先保证不超出配额限制
4. WHEN 数据库事务失败时 THEN 系统 SHALL 能够回滚配额状态到一致状态

### 需求7: 配额优先级处理

**用户故事:** 作为系统，我需要明确处理用户级和API密钥级配额同时存在时的优先级，以便提供一致的配额执行逻辑。

#### 验收标准

1. WHEN 用户级配额和API密钥级配额同时存在时 THEN 系统 SHALL 两者都检查，任一超限都拒绝请求
2. IF 用户级配额被设置为无限制 THEN 系统 SHALL 仅检查API密钥级配额
3. IF API密钥级配额被设置为无限制 THEN 系统 SHALL 仅检查用户级配额
4. WHEN 两个层级的配额都有限制时 THEN 系统 SHALL 按照更严格的限制执行
5. WHEN 管理员用户请求时 THEN 系统 SHALL 可以绕过配额限制（可配置选项）

## 非功能性需求

### 代码架构和模块化

- **单一职责原则**: 配额服务应专门负责配额检查和管理，不涉及其他业务逻辑。
- **模块化设计**: 配额检查、规则管理、缓存应作为独立的、可重用的组件。
- **依赖管理**: 配额模块与认证、日志等模块的依赖关系应清晰且最小化。
- **清晰接口**: 定义配额服务与外部调用者（如认证中间件）之间的清晰合约。

### 性能

- 配额检查过程对 API 请求延迟的影响应尽可能小，目标 P99 < 20ms (不含数据库查询)。

### 可靠性

- 配额计数应具有强一致性保证，即使在异步日志记录和高并发场景下也 SHALL 不能导致严重的过量请求。
- 配额系统 SHALL 能够处理数据库连接失败等异常情况，并在恢复后保持配额状态的一致性。
- WHEN 配额计算服务不可用时 THEN 系统 SHALL 采用降级策略，暂时限制请求而不是允许无限制访问。

### 可用性

- 在 UI 中设置配额的界面应直观易懂，并提供必要的输入验证和反馈。
- WHEN 配额接近上限时 THEN 系统 SHALL 提供清晰的使用情况提示和剩余配额信息。

### 安全性

- 配额参数的修改操作 SHALL 通过认证和授权验证。
- WHEN 检测到配额绕过攻击时 THEN 系统 SHALL 记录安全日志并采取防护措施。
- 配额计数信息 SHALL 防止未授权的访问和篡改。

## 假设与约束

- **假设**: 配额检查依赖于 `request_logs` 表中记录的成功请求。
- **约束**: 初始版本仅支持基于请求次数的频率限制。未来可能需要扩展支持基于 Token 的配额。
- **约束**: 配额统计的时间窗口是滑动的（例如，“过去 60 分钟”）。
