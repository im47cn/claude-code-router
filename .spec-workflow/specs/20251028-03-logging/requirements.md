# 需求文档

## 简介

本文档定义了 `claude-code-router` 异步请求日志系统的功能需求。该系统旨在捕获通过 API 密钥认证的请求的详细信息，并将其持久化到 MySQL 数据库中，同时确保日志记录过程不影响 API 响应性能。

## 产品愿景对齐

- **请求日志与分析**: 这是该功能的核心目标，为未来的使用情况分析和审计提供数据基础。
- **用户管理与访问控制**: 通过记录用户请求历史，增强了用户管理和审计能力。
- **性能**: 异步设计确保了日志记录不会影响核心 API 的响应延迟，符合项目对性能的重视。

## 需求

### 需求1: 日志记录触发

**用户故事:** 作为系统管理员，我希望所有通过 API 密钥认证的核心路由请求都被记录下来，以便进行审计和问题排查。

#### 验收标准

1. 当系统接收到一个通过有效 API 密钥认证的核心路由请求时（如 `/v1/messages`），系统应记录该请求的日志。
2. 如果请求因配额超限被拒绝，系统应仍记录一条状态为 `quota_exceeded` 的日志条目。
3. 如果请求在处理过程中发生错误（如上游 LLM 访问失败），系统应仍记录一条状态为 `error` 的日志条目。

### 需求2: 记录内容

**用户故事:** 作为开发者或管理员，我希望每条日志都包含详尽的请求和响应信息，以便进行全面的分析和调试。

#### 验收标准

1. 当记录日志时，每条记录应包含核心信息：`user_id`, `api_key_id`, `request_timestamp`, `request_url`, `request_method`, `routed_provider`, `routed_model`, `status_code`, `status`, `response_timestamp`, `response_time_ms`。
2. 当记录请求头和响应头时，系统必须对敏感字段（如 `Authorization`, `Cookie`）进行脱敏处理，并以 JSON 格式存储。
3. 当记录请求体和响应体时，系统必须能够存储可能很大的文本内容（如 `LONGTEXT`）。对于流式响应，应记录拼接后的完整内容。
4. 如果请求处理过程中发生错误，日志记录中必须包含错误信息或堆栈跟踪。
5. 如果请求涉及 LLM 调用，日志记录应包含输入和输出的 Token 数量。

### 需求3: 异步处理

**用户故事:** 作为 API 的使用者，我希望我的请求能被快速处理，而不被后端的日志记录操作所拖慢。

#### 验收标准

1. 当系统处理 API 请求时，日志的数据库写入过程必须与主请求处理线程解耦。
2. 当系统返回 API 响应时，不得等待日志写入数据库完成。
3. 如果采用多线程/多进程方案，系统必须使用 `worker_threads` 来实现异步日志写入。

### 需求4: 可靠性与错误处理

**用户故事:** 作为系统运维人员，我希望日志系统是健壮的，即使在数据库暂时故障时也不会丢失重要的日志数据。

#### 验收标准

1. 如果数据库暂时不可用，日志记录 Worker 不应崩溃，并应尝试进行重试写入。
2. 如果日志持续无法写入数据库，系统应将其保存到备用存储（如本地文件系统的一个 `.jsonl` 文件）中。
3. 如果日志 Worker 意外退出，主线程应能检测到并尝试重启或记录关键错误。
4. 当服务正常关闭时，系统应尝试将内部队列中剩余的日志全部写入数据库或备用存储。

### 需求5: 存储与查询

**用户故事:** 作为普通用户，我希望能够查询我自己的 API 请求历史，以便跟踪我的使用情况。

#### 验收标准

1. 当日志被创建时，它们必须被持久化存储在 MySQL 数据库的 `request_logs` 表中。
2. 当用户查询其请求历史时，系统必须提供一个 API 接口，允许根据用户 ID 查询，并支持按时间范围过滤和分页。

## 非功能性需求

### 代码架构和模块化

- **单一职责原则**: 日志 Worker 应只负责从主线程接收数据并写入数据库。
- **模块化设计**: 日志数据的收集、脱敏和发送应封装为独立的工具或服务。
- **清晰接口**: 主线程与日志 Worker 之间的通信接口（`postMessage`）应清晰定义。

### 性能

- 异步日志记录对主线程 API 请求处理的性能影响应极小。

### 安全性

- 在将日志数据发送给 Worker 或写入数据库之前，必须对所有敏感信息（API 密钥、Authorization 头等）进行脱敏处理。

### 可靠性

- 日志记录应尽量完整，允许在进程异常退出时丢失少量（例如，最多一个批次）正在处理的日志。
- 日志 Worker 的资源消耗应在合理范围内，不应影响主服务的稳定性。

### 可用性

- 用户查询历史记录的 API 应响应迅速，这要求数据库表有合适的索引。

## 原始文档的附加内容

### 假设与约束

- **假设**: API 请求和响应体的大小在 `LONGTEXT` (MySQL) 的存储限制内。
- **约束**: 初始版本不要求实现复杂的日志查询或可视化界面，仅需支持用户按时间范围查询自己的历史记录。
- **约束**: 日志脱敏规则需要根据实际部署环境和安全要求进行配置。
