# 认证与 API 密钥管理需求文档

## 1. 概述

本文档定义了 `claude-code-router` 新增的用户认证、API 密钥管理及相关功能的需求。目标是提供一个安全的、基于角色的访问控制系统，允许用户通过飞书登录并管理自己的 API 密钥以访问路由服务。

## 2. 功能需求

### 2.1 用户认证 (UI)

* **FR-AUTH-001**: 系统 **必须** 支持用户通过飞书 OAuth 进行登录。
* **FR-AUTH-002**: 系统 **不得** 提供本地注册功能。用户首次通过飞书登录时，系统应自动创建关联的用户账户。
* **FR-AUTH-003**: 成功登录后，系统 **必须** 维持用户的登录状态（通过 Session 或 JWT）。
* **FR-AUTH-004**: 用户 **必须** 能够登出系统。
* **FR-AUTH-005**: 用户的基本信息（姓名、头像）**应** 从飞书同步并在 UI 中显示。
* **FR-AUTH-006**: 系统 **应** 能够识别管理员用户 (`is_admin=true`)，并可能在 UI 中展示管理员特定的功能入口。

### 2.2 API 认证 (后端服务)

* **FR-API-AUTH-001**: 对 `/v1/messages` 等核心路由 API 的访问 **必须** 通过用户生成的 API 密钥进行认证。
* **FR-API-AUTH-002**: API 密钥 **必须** 通过 `Authorization: Bearer <API_KEY>` 或 `X-Api-Key: <API_KEY>` 请求头传递。
* **FR-API-AUTH-003**: 系统 **必须** 验证 API 密钥的有效性（存在、未禁用、未过期 - 如果实现了过期）。
* **FR-API-AUTH-004**: 无效或缺失 API 密钥的请求 **必须** 返回 `401 Unauthorized` 错误。
* **FR-API-AUTH-005**: API 密钥 **必须** 与特定的用户账户关联。
* **FR-API-AUTH-006**: 系统 **不得** 在任何日志或响应中明文存储或返回完整的 API 密钥。

### 2.3 API 密钥管理 (UI)

* **FR-KEY-MGT-001**: 已登录用户 **必须** 能够创建新的 API 密钥。
* **FR-KEY-MGT-002**: 创建 API 密钥时，用户 **可以** 为其指定一个名称（可选）。
* **FR-KEY-MGT-003**: 新生成的 API 密钥 **必须** 完整显示给用户**一次**，并提示用户妥善保存。系统之后 **不得** 再次完整显示该密钥。
* **FR-KEY-MGT-004**: 用户 **必须** 能够查看自己创建的所有 API 密钥列表，列表中应显示密钥名称、前缀、创建时间、最后使用时间（若有）、状态（启用/禁用）和设置的配额规则。
* **FR-KEY-MGT-005**: 用户 **必须** 能够启用或禁用自己的 API 密钥。
* **FR-KEY-MGT-006**: 用户 **必须** 能够删除自己的 API 密钥。删除前 **应** 有确认提示。
* **FR-KEY-MGT-007**: 用户 **可以** 为每个 API 密钥设置独立的配额规则（请求次数上限 `limit` 和时间窗口 `interval_minutes`）。

### 2.4 用户角色与权限

* **FR-ROLE-001**: 系统 **必须** 区分普通用户和管理员用户 (`is_admin`)。
* **FR-ROLE-002**: 默认情况下，通过飞书登录的用户为普通用户。
* **FR-ROLE-003**: 管理员 **必须** 拥有额外的权限，例如设置用户级配额。 (管理员管理功能的具体需求将在单独的 `admin/requirements.md` 中定义)。
* **FR-ROLE-004**: 普通用户只能管理自己的 API 密钥和查看自己的请求历史。

### 2.5 安全性

* **FR-SEC-001**: API 密钥 **必须** 使用强哈希算法 (如 bcrypt 或 Argon2) 加盐存储在数据库中。
* **FR-SEC-002**: API 密钥的验证 **必须** 使用恒定时间比较算法，以防止时序攻击。
* **FR-SEC-003**: UI 登录状态的管理（Session 或 JWT）**必须** 采取安全措施（例如，HttpOnly Cookie，安全的签名密钥）。
* **FR-SEC-004**: 飞书 OAuth 集成中使用的 App ID 和 App Secret **必须** 安全存储，不得硬编码。

## 3. 非功能性需求

* **NFR-AUTH-001**: API 密钥验证过程的性能开销应尽可能小，目标 P99 延迟 < 50ms (不含数据库查询)。
* **NFR-AUTH-002**: 用户登录过程应流畅，飞书回调处理时间目标 P99 < 500ms (不含飞书响应时间)。

## 4. 假设与约束

* **A-AUTH-001**: 飞书开放平台提供可靠的 OAuth2 服务。
* **C-AUTH-001**: 初始版本仅支持飞书作为唯一登录方式。
* **C-AUTH-002**: 系统部署环境能够安全地管理飞书 App Secret 和 JWT/Session 密钥。
