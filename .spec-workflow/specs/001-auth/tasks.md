# 任务文档

- [ ] 1. 设置数据库模式和模型
  - 文件: prisma/schema.prisma (修改现有文件)
  - 定义 User, UserIdentity, ApiKey, UserQuota, ApiKeyQuota, RequestLog 模型
  - 创建并运行数据库迁移
  - 目的: 为认证系统建立数据持久化层
  - _重用: 现有数据库配置, src/db/client.ts_
  - _需求: 需求1, 需求2, 需求3_
  - _提示: 角色: 专精Prisma和MySQL模式设计的数据库工程师 | 任务: 根据需求创建 User, UserIdentity, ApiKey, UserQuota, ApiKeyQuota, 和 RequestLog 模型的完整数据库模式，然后使用Prisma生成并应用迁移 | 限制: 必须遵循现有数据库模式，确保正确的外键关系，为性能添加必要的索引，维护数据完整性约束 | 成功: 模式正确定义所有必需字段，迁移成功执行，关系正确建立，性能索引就位_

- [ ] 2. 创建认证类型和接口
  - 文件: src/types/auth.ts
  - 为 User, ApiKey, Quota 和认证相关数据结构定义TypeScript接口
  - 扩展现有基础类型系统中的基础接口
  - 目的: 为认证实现建立类型安全
  - _重用: src/types/ 中的现有类型定义_
  - _需求: 需求1, 需求2, 需求4_
  - _提示: 角色: 专精类型系统和安全接口的TypeScript开发人员 | 任务: 为认证数据结构创建全面的TypeScript接口，包括 User, ApiKey, Quota 和相关类型，扩展现有基础类型模式 | 限制: 必须维护类型安全，遵循现有命名约定，确保接口与数据库模式对齐，支持所有认证流程 | 成功: 所有接口编译无错误，为认证功能提供适当的类型覆盖，接口与数据库模型和API合约对齐_

- [ ] 3. 实现API密钥生成和验证服务
  - 文件: src/auth/apiKey.ts
  - 创建具有高熵和sk-前缀的API密钥生成
  - 实现bcrypt哈希和恒定时间比较
  - 添加密钥前缀提取用于缓存优化
  - 目的: 提供安全的API密钥管理功能
  - _重用: 现有加密工具, src/utils/cache.ts_
  - _需求: 需求2, 需求5_
  - _提示: 角色: 专精密码学和认证系统的安全工程师 | 任务: 实现安全的API密钥生成、bcrypt哈希和恒定时间比较验证逻辑，包括密钥前缀提取用于缓存优化 | 限制: 必须使用加密安全的随机生成，实施适当的bcrypt加盐，确保恒定时间比较防止时序攻击，遵循安全最佳实践 | 成功: API密钥以足够熵生成，哈希安全且加盐，验证防止时序攻击，密钥提取支持缓存策略_

- [ ] 4. 创建认证中间件
  - 文件: src/middleware/auth.ts
  - 实现用于API密钥验证的Fastify preHandler钩子
  - 添加用户信息附加到请求对象
  - 处理认证错误并提供适当的HTTP状态码
  - 目的: 通过认证检查保护API端点
  - _重用: 现有Fastify实例, src/auth/apiKey.ts_
  - _需求: 需求2_
  - _提示: 角色: 专精Fastify中间件和认证流程的后端开发人员 | 任务: 创建Fastify preHandler中间件，集成API密钥验证，将用户信息附加到请求，并处理具有适当HTTP状态码的认证错误 | 限制: 必须与现有Fastify设置无缝集成，处理所有认证失败场景，维护请求处理性能，提供不暴露敏感信息的清晰错误响应 | 成功: 中间件成功保护端点，正确验证API密钥，正确附加用户上下文，使用适当HTTP响应处理所有错误场景_

- [ ] 5. 实现配额检查服务
  - 文件: src/services/quotaService.ts
  - 创建用户级和API密钥级配额验证
  - 实现基于时间窗口的请求计数
  - 添加配额规则和计数器的缓存
  - 目的: 强制执行请求限制以防止滥用
  - _重用: 现有数据库连接, src/utils/cache.ts_
  - _需求: 需求3_
  - _提示: 角色: 专精速率限制和缓存策略的后端开发人员 | 任务: 实现全面的配额检查服务，支持用户级和API密钥级限制，具有基于时间窗口的计数和缓存以提高性能 | 限制: 必须确保准确的配额强制执行，处理时间窗口边界等边缘情况，实施高效的缓存策略，在分布式请求中维护一致性 | 成功: 配额强制执行准确且高性能，时间窗口处理正确，缓存在不牺牲准确性的前提下提高性能，边缘情况得到适当处理_

- [ ] 6. 创建飞书OAuth服务
  - 文件: src/auth/feishu.ts
  - 实现具有state参数的OAuth URL生成
  - 添加具有代码交换和用户信息检索的回调处理
  - 包括用户创建/查找和会话管理
  - 目的: 通过飞书平台启用用户认证
  - _重用: 现有HTTP客户端, 会话管理系统_
  - _需求: 需求1_
  - _提示: 角色: 专精OAuth2流程和第三方集成的后端开发人员 | 任务: 实现完整的飞书OAuth服务，包括具有CSRF保护的URL生成、具有令牌交换的回调处理、用户信息检索和会话管理 | 限制: 必须遵循OAuth2安全最佳实践，正确处理state参数进行CSRF保护，安全存储飞书凭证，优雅处理OAuth错误，管理用户创建和会话生命周期 | 成功: OAuth流程安全且完整，实施CSRF保护，正确检索和存储用户信息，会话管理正确_

- [ ] 7. 实现认证API端点
  - 文件: src/api/auth.ts
  - 创建 /auth/feishu 重定向端点
  - 添加 /auth/feishu/callback 处理器
  - 实现 /auth/logout 端点
  - 添加 /api/me 端点用于当前用户信息
  - 目的: 为认证操作提供HTTP接口
  - _重用: 现有API结构, src/auth/feishu.ts, Fastify session_
  - _需求: 需求1, 需求4_
  - _提示: 角色: 专精REST端点和认证流程的API开发人员 | 任务: 创建全面的认证API端点，包括飞书OAuth重定向、回调处理、登出和用户信息检索，遵循REST约定和安全实践 | 限制: 必须遵循现有API模式，实施适当的错误处理，确保会话安全，处理OAuth state验证，提供清晰的响应格式 | 成功: 所有认证端点正常工作，OAuth流程正确实施，会话安全，用户信息准确检索和返回_

- [ ] 8. 创建API密钥管理端点
  - 文件: src/api/keys.ts
  - 实现用于密钥创建的 POST /api/keys
  - 添加用于密钥列表的 GET /api/keys
  - 创建用于密钥更新的 PUT /api/keys/{keyId}
  - 添加用于密钥删除的 DELETE /api/keys/{keyId}
  - 目的: 为API密钥管理提供CRUD接口
  - _重用: 现有API模式, src/auth/apiKey.ts, 数据库模型_
  - _需求: 需求3_
  - _提示: 角色: 专精CRUD操作和安全的API开发人员 | 任务: 实现完整的API密钥管理端点，具有适当的验证、安全检查和错误处理，确保密钥仅在创建时返回且此后得到适当管理 | 限制: 必须验证用户权限，创建后绝不暴露完整API密钥，实施适当的输入验证，处理密钥未找到或权限被拒绝等边缘情况，维护数据一致性 | 成功: 所有CRUD操作安全工作，API密钥得到适当保护，用户权限得到强制执行，输入验证防止无效数据，错误处理全面_

- [ ] 9. 实现API密钥配额管理端点
  - 文件: src/api/quotas.ts
  - 创建用于设置密钥配额的 PUT /api/keys/{keyId}/quota
  - 添加用于移除配额的 DELETE /api/keys/{keyId}/quota
  - 包括配额验证和冲突检查
  - 目的: 为管理API密钥速率限制提供接口
  - _重用: src/services/quotaService.ts, 现有API模式_
  - _需求: 需求3_
  - _提示: 角色: 专精细速率限制和配置管理的API开发人员 | 任务: 创建设置和移除API密钥配额的API端点，具有适当的验证、冲突检查和配额服务集成 | 限制: 必须验证配额参数，防止无效配额配置，确保与配额检查服务的正确集成，安全处理并发配额修改 | 成功: 配额端点正确管理速率限制，验证防止无效配置，与配额服务集成无缝，并发修改得到安全处理_

- [ ] 10. 创建登录页面组件
  - 文件: ui/src/pages/LoginPage.tsx
  - 实现具有重定向处理的飞书登录按钮
  - 添加加载状态和错误处理
  - 包括响应式设计和可访问性
  - 目的: 为认证提供用户界面
  - _重用: 现有UI组件, ui/src/components/, ui/src/hooks/_
  - _需求: 需求1_
  - _提示: 角色: 专精React和认证UI的前端开发人员 | 任务: 创建具有飞书OAuth集成的全面登录页面，包括加载状态、错误处理、响应式设计和可访问性功能 | 限制: 必须遵循现有UI模式和主题系统，实施适当的错误状态，确保可访问性合规，正确处理重定向流程，提供良好的用户反馈 | 成功: 登录界面直观且可访问，OAuth流程无缝工作，错误状态用户友好，响应式设计在各种设备上工作，满足可访问性标准_

- [ ] 11. 实现API密钥管理界面
  - 文件: ui/src/pages/ApiKeyManagementPage.tsx
  - 创建具有状态和元数据显示的密钥列表
  - 添加具有一次性显示的密钥创建模态框
  - 实现密钥编辑（名称/状态）和删除流程
  - 目的: 为API密钥操作提供用户界面
  - _重用: 现有UI组件, ui/src/components/, ui/src/hooks/_
  - _需求: 需求3_
  - _提示: 角色: 专精数据管理界面和安全UI的前端开发人员 | 任务: 创建具有安全密钥创建、列表、编辑和删除流程的全面API密钥管理界面，包括一次性密钥显示等适当安全考虑 | 限制: 必须确保创建后绝不完全显示API密钥，为破坏性操作实施确认对话框，遵循现有UI模式，提供清晰的状态指示器，适当处理加载和错误状态 | 成功: 界面提供安全直观的密钥管理，密钥通过一次性显示得到适当保护，用户操作有适当的确认，界面遵循既定设计模式_

- [ ] 12. 创建认证上下文和钩子
  - 文件: ui/src/contexts/AuthContext.tsx, ui/src/hooks/useAuth.ts
  - 实现认证状态管理
  - 添加登录/登出功能和用户会话处理
  - 创建受保护的路由组件
  - 目的: 管理前端认证状态和路由
  - _重用: 现有上下文模式, ui/src/contexts/, ui/src/hooks/_
  - _需求: 需求1, 需求4_
  - _提示: 角色: 专精React上下文和认证状态管理的前端开发人员 | 任务: 创建具有适当状态管理、登录/登出功能、会话处理和受保护路由组件的认证上下文系统 | 限制: 必须遵循现有上下文模式，优雅处理会话过期，提供适当的加载状态，实施安全令牌存储，确保路由保护正常工作 | 成功: 认证状态管理得当，登录/登出流程正常工作，会话处理安全，受保护路由防止未授权访问，用户体验流畅_

- [ ] 13. 为认证服务创建单元测试
  - 文件: tests/auth/apiKey.test.ts, tests/auth/feishu.test.ts
  - 测试API密钥生成、哈希和验证
  - 添加具有模拟依赖的OAuth服务功能测试
  - 包括边缘情况和错误场景
  - 目的: 确保认证逻辑可靠性
  - _重用: 现有测试工具, tests/helpers/_
  - _需求: 需求2, 需求5_
  - _提示: 角色: 专精单元测试和安全测试的QA工程师 | 任务: 为认证服务创建全面的单元测试，覆盖API密钥操作、OAuth功能和具有适当模拟和安全考虑的边缘情况 | 限制: 必须模拟所有外部依赖，测试成功和失败场景，覆盖安全边缘情况，确保测试隔离且可重复，达到高代码覆盖率 | 成功: 所有认证功能经过彻底测试，覆盖安全场景，处理边缘情况，测试为认证可靠性提供信心_

- [ ] 14. 为API端点创建集成测试
  - 文件: tests/api/auth.test.ts, tests/api/keys.test.ts
  - 测试完整认证流程
  - 添加API密钥管理CRUD测试
  - 包括配额管理集成测试
  - 目的: 确保API端点与数据库正常工作
  - _重用: 现有测试数据库设置, tests/helpers/_
  - _需求: 所有需求_
  - _提示: 角色: 专精API集成测试和数据库测试的QA工程师 | 任务: 为所有认证和密钥管理API端点创建全面的集成测试，包括数据库交互和完整的请求-响应周期 | 限制: 必须使用具有适当设置/清理的测试数据库，使用各种输入场景测试所有端点，验证数据库状态更改，在测试中正确处理认证，确保测试隔离 | 成功: 所有API端点端到端测试，数据库操作正常工作，认证流程得到验证，错误场景得到适当处理_

- [ ] 15. 为用户流程创建端到端测试
  - 文件: tests/e2e/auth.test.ts
  - 测试从UI到API的完整登录流程
  - 添加API密钥管理UI测试
  - 包括配额配置和验证
  - 目的: 确保完整用户工作流程正常运行
  - _重用: 现有E2E测试设置, tests/e2e/_
  - _需求: 所有需求_
  - _提示: 角色: 专精端到端测试和用户旅程验证的QA自动化工程师 | 任务: 创建涵盖完整用户旅程的全面E2E测试，包括从用户界面角度的登录、API密钥管理和配额配置 | 限制: 必须测试真实用户工作流程，避免测试实现细节，确保测试可维护且可靠，适当处理外部依赖，模拟真实用户行为 | 成功: 完整用户工作流程从头到尾正常工作，UI交互如预期，后端集成无缝，用户体验端到端得到验证_

- [ ] 16. 实施安全测试和验证
  - 文件: tests/security/authSecurity.test.ts
  - 测试API密钥安全（无泄漏、适当哈希）
  - 添加会话安全验证
  - 包括速率限制和配额强制执行测试
  - 目的: 验证安全措施有效
  - _重用: 现有安全测试模式_
  - _需求: 需求5_
  - _提示: 角色: 专精渗透测试和安全验证的安全工程师 | 任务: 创建全面的安全测试以验证API密钥保护、会话安全、速率限制有效性和其他认证安全措施 | 限制: 必须测试常见安全漏洞，验证对时序攻击的保护，测试速率限制绕过尝试，确保无敏感数据泄漏，验证会话安全实施 | 成功: 安全措施有效防护常见漏洞，速率限制不易被绕过，敏感数据得到适当保护，会话安全，认证系统满足安全要求_

## 原始文档的附加内容

### 任务依赖关系和关联

**前置条件:**
- 数据库模式（任务1）必须在所有其他任务之前完成
- 认证类型（任务2）必须在服务实现之前完成

**核心认证流程:**
- API密钥服务（任务3）→ 认证中间件（任务4）→ API端点（任务7, 8, 9）
- 配额服务（任务5）必须与认证中间件（任务4）集成

**前端集成:**
- 认证上下文（任务12）→ 登录页面（任务10）→ API密钥管理（任务11）
- 前端组件依赖于相应的后端API端点

**测试策略:**
- 单元测试（任务13）可与实现并行开发
- 集成测试（任务14）需要完成的API端点
- 端到端测试（任务15）需要前端和后端都完成
- 安全测试（任务16）应在实现完成后执行

### 实施说明

**配置要求:**
- 飞书OAuth应用凭证必须安全配置
- 会话密钥和cookie设置需要适当配置
- 数据库连接和缓存配置必须支持认证系统
- 速率限制参数应按部署可配置

**性能考虑:**
- API密钥验证应通过缓存优化
- 配额检查的数据库查询应高效
- 会话存储应支持预期用户负载
- 速率限制不应显著影响合法用户

**安全考虑:**
- API密钥绝不能被记录或在错误消息中暴露
- 会话cookie应使用安全标志和HttpOnly
- 必须为OAuth state实施CSRF保护
- 速率限制应防止滥用和意外过度使用